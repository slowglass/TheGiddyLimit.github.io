"use strict";const BookUtil={getHeaderText(a){return a.header||a},_getSelectors(a){return a=a.trim().toLowerCase(),[`.rd__h--0 > .entry-title-inner:textEquals("${a}")`,`.rd__h--1 > .entry-title-inner:textEquals("${a}")`,`.rd__h--2 > .entry-title-inner:textEquals("${a}")`,`.rd__h--2-inset > .entry-title-inner:textEquals("${a}")`,`.rd__h--3 > .entry-title-inner:textEquals("${a}.")`]},scrollClick(a,b,c){if(null!=c&&!~BookUtil.curRender.chapter){const d=$(c).closest(".bk-headers"),e=d.parent().children(".bk-headers").filter((b,c)=>$(c).find(`[data-header="${a}"]`).length);b=e.index(d)}const d=BookUtil._getSelectors(a);if(null==b){const a=$(d[0]);if(a.length)return void a[0].scrollIntoView();const b=$(d[1]);if(b.length)return void b[0].scrollIntoView();const c=$(d[2]);if(c.length)return void c[0].scrollIntoView();const e=$(d[3]);e.length&&e[0].scrollIntoView();const f=$(d[4]);f.length&&f[0].scrollIntoView()}else{const a=$(`${d[0]}, ${d[1]}, ${d[2]}, ${d[3]}, ${d[4]}`);a.length&&(a[b]?a[b].scrollIntoView():a[0].scrollIntoView())}},scrollPageTop(a){if(a&&!~BookUtil.curRender.chapter){const b=BookUtil.thisContents.children("ul").children("li").children("a").index(a);if(~b){const a=$(`#pagecontent tr.text td`).children(`.${Renderer.HEAD_NEG_1}`)[b];a?a.scrollIntoView():setTimeout(()=>{throw new Error(`Failed to find header scroll target with index "${b}"`)})}else setTimeout(()=>{throw new Error(`Failed to find element within contents items`)})}else document.getElementById(`pagecontent`).scrollIntoView()},makeContentsBlock(a){let b=`<ul class="bk-contents" ${a.defaultHidden?`style="display: none;"`:""}>`;return a.book.contents.forEach((d,c)=>{b+=`<li>
				<a href="${a.addPrefix||""}#${UrlUtil.encodeForHash(a.book.id)},${c}" ${a.addOnclick?`onclick="BookUtil.scrollPageTop(this)"`:""}>
					<span class="sect">${Parser.bookOrdinalToAbv(d.ordinal)}${d.name}</span>
				</a>
			</li>`,b+=BookUtil.makeHeadersBlock(a.book.id,c,d,a.addPrefix,a.addOnclick,a.defaultHeadersHidden)}),b+="</ul>",b},makeHeadersBlock(a,b,c,d,e,f){let g=`<ul class="bk-headers" ${f?`style="display: none;"`:""}>`;return c.headers&&c.headers.forEach(c=>{const f=BookUtil.getHeaderText(c),h=c.header?`<span class="bk-contents__sub_spacer--1">\u2013</span>${c.header}`:c;g+=`<li>
				<a href="${d||""}#${a},${b},${UrlUtil.encodeForHash(f)}" data-book="${a}" data-chapter="${b}" data-header="${f}" ${e?`onclick="BookUtil.scrollClick('${f.replace(/'/g,"\\'")}', null, this)"`:""}>${h}</a>
			</li>`}),g+="</ul>",g},addHeaderHandles(a){const b=$(`ul.bk-headers`);b.prev(`li`).find(`a`).css({display:"flex","justify-content":"space-between",padding:"0"}),b.filter((a,b)=>$(b).children().length).each((b,c)=>{const d=$(c),e=d.prev(`li`).find(`a`);e.children(`.showhide`).length||e.append(`<span class="showhide" onclick="BookUtil.sectToggle(event, this)" data-hidden="true">${a?`[+]`:`[\u2013]`}</span>`)})},sectToggle(a,b){a&&(a.stopPropagation(),a.preventDefault());const c=$(b),d=c.closest(`li`).next(`ul.bk-headers`);c.data("hidden")?(d.show(),c.data("hidden",!1),c.html(`[\u2013]`)):(d.hide(),c.data("hidden",!0),c.html(`[+]`))},_buildHeaderMap(a,b){function c(a,b){if(("section"===a.type||"entries"===a.type)&&a.entries&&a.name){const e=/^([A-Z]+\d+(?:[a-z]+)?)\./.exec(a.name.trim());if(e){const c=e[1];if(d[c])throw new Error(`Header "${c}" was already defined!`);d[c]={chapter:b,entry:a}}else{const c=/^(\d+(?:[A-Za-z]+)?)\./.exec(a.name.trim());if(c){let e=`${b}>${c[1]}>0`;for(;d[e];)e=e.split(">"),e[e.length-1]=+e.last()+1,e=e.join(">");d[e]=d[e]={chapter:b,entry:a}}else d[a.name]={chapter:b,entry:a}}a.entries.forEach(a=>c(a,b))}}const d={};a.forEach((a,b)=>c(a,b));const e={},f=Object.keys(d);return f.forEach(a=>{if(a.includes(">")){const b=a.split(">").slice(0,2).join(">");(e[b]=e[b]||[]).push(a)}}),f.forEach(a=>{if(a.includes(">")){const b=a.split(">").slice(0,2).join(">");1===e[b].length&&(d[b]=d[a],delete d[a])}}),d},thisContents:null,curRender:{curBookId:"NONE",chapter:null,data:{},fromIndex:{},lastRefHeader:null,controls:{},headerMap:{}},_lastClickedLink:null,showBookContent(a,b,c,d){function e(){$(`.${Renderer.HEAD_NEG_1}`).show(),$(`.rd__hr--section`).show()}function f(a){if(e(),a&&~BookUtil.curRender.chapter){const b=$(`.${Renderer.HEAD_NEG_1}`),c=b.filter((b,c)=>{const d=$(c),e=a.trim().toLowerCase(),f=d.children(`.rd__h`).find(`span.entry-title-inner`).filter(`:textEquals("${e}")`);return f.length});return c.length?(BookUtil.curRender.lastRefHeader=a.toLowerCase(),b.hide(),$(`hr.rd__hr--section`).hide(),c.show(),MiscUtil.scrollPageTop()):BookUtil.curRender.lastRefHeader=null,!!c.length}}let g,h,i=0,j=!1;if(d&&0<d.length&&(i=+d[0]),d&&1<d.length?(g=$(`[href="#${c},${i},${d[1]}"]`).data("header"),BookUtil.referenceId&&f(g),!g&&(g=decodeURIComponent(d[1]),d[2]&&(h=+d[2]),j=!0)):BookUtil.referenceId&&e(),BookUtil.curRender.data=a,BookUtil.curRender.fromIndex=b,BookUtil.curRender.headerMap=BookUtil._buildHeaderMap(a),BookUtil.curRender.chapter!==i||UrlUtil.encodeForHash(BookUtil.curRender.curBookId.toLowerCase())!==UrlUtil.encodeForHash(c)){if(BookUtil.thisContents.children(`ul`).children(`ul, li`).removeClass("active"),~i){BookUtil.thisContents.children(`ul`).children(`li:nth-of-type(${i+1}), ul:nth-of-type(${i+1})`).addClass("active");const a=BookUtil.thisContents.children(`ul`).children(`li:nth-of-type(${i+1})`).find(`.showhide`);a.data("hidden")&&a.click()}else BookUtil.thisContents.children(`ul`).children(`li`).find(`.showhide`).each((a,b)=>{const c=$(b);c.data("hidden")&&c.click()});BookUtil.curRender.curBookId=c,BookUtil.curRender.chapter=i,BookUtil.renderArea.html("");const d=(b.contents[i]||{}).name;document.title=`${d?`${d} - `:""}${b.name} - 5etools`;const e=a=>{const b=()=>{const b=[c,i+a];window.location.hash=b.join(HASH_PART_SEP),MiscUtil.scrollPageTop()};if(BookUtil.referenceId&&BookUtil.curRender.lastRefHeader){const d=BookUtil.curRender.fromIndex.contents[i],e=d.headers.findIndex(a=>BookUtil.getHeaderText(a).toLowerCase()===BookUtil.curRender.lastRefHeader);if(!~e)b();else if(d.headers[e+a]){const b=[c,i,BookUtil.getHeaderText(d.headers[e+a]).toLowerCase()];window.location.hash=b.join(HASH_PART_SEP)}else{b();const d=BookUtil.curRender.fromIndex.contents[i+a].headers,e=0<a?0:d.length-1,f=[c,i+a,d[e].toLowerCase()];window.location.hash=f.join(HASH_PART_SEP)}}else b()},j=b=>{const c=`padding-${b?"top":"bottom"}: 6px; padding-left: 9px; padding-right: 9px;`,d=$(`<div class="split"/>`).appendTo($(`<td colspan="6" style="${c}"/>`).appendTo($(`<tr/>`).appendTo(BookUtil.renderArea))),f=~i&&0<i;(BookUtil.curRender.controls.$btnsPrv=BookUtil.curRender.controls.$btnsPrv||[]).push($(`<button class="btn btn-xs btn-default bk__nav-head-foot-item"><span class="glyphicon glyphicon-chevron-left"></span>Previous</button>`).click(()=>e(-1)).toggle(f).appendTo(d)),(BookUtil.curRender.controls.$divsPrv=BookUtil.curRender.controls.$divsPrv||[]).push($(`<div class="bk__nav-head-foot-item"/>`).toggle(!f).appendTo(d)),b?$(`<button class="btn btn-xs btn-default ${~BookUtil.curRender.chapter?"":"active"}" title="Warning: Slow">View Entire ${BookUtil.contentType.uppercaseFirst()}</button>`).click(()=>{window.location.href=(~BookUtil.curRender.chapter?BookUtil.thisContents.find(`.bk__contents_show_all`):BookUtil.thisContents.find(`.bk__contents_header_link`)).attr("href")}).appendTo(d):$(`<button class="btn btn-xs btn-default">Back to Top</button>`).click(()=>MiscUtil.scrollPageTop()).appendTo(d);const g=~i&&i<a.length-1;(BookUtil.curRender.controls.$btnsNxt=BookUtil.curRender.controls.$btnsNxt||[]).push($(`<button class="btn btn-xs btn-default bk__nav-head-foot-item">Next<span class="glyphicon glyphicon-chevron-right"></span></button>`).click(()=>e(1)).toggle(g).appendTo(d)),(BookUtil.curRender.controls.$divsNxt=BookUtil.curRender.controls.$divsNxt||[]).push($(`<div class="bk__nav-head-foot-item"/>`).toggle(!g).appendTo(d))};BookUtil.curRender.controls={},BookUtil.renderArea.append(Renderer.utils.getBorderTr()),j(!0);const k=[];if(BookUtil._renderer.setFirstSection(!0),BookUtil._renderer.setLazyImages(!0),BookUtil._renderer.resetHeaderIndex(),-1==i?a.forEach(a=>BookUtil._renderer.recursiveRender(a,k)):BookUtil._renderer.recursiveRender(a[i],k),BookUtil.renderArea.append(`<tr class="text"><td colspan="6">${k.join("")}</td></tr>`),Renderer.initLazyImageLoaders(),BookUtil._renderer.setLazyImages(!1),j(),BookUtil.renderArea.append(Renderer.utils.getBorderTr()),g){let a=!1;BookUtil.referenceId&&(a=f(g)),a||(setTimeout(()=>{BookUtil.scrollClick(g,h)},BookUtil.isHashReload?15:75),BookUtil.isHashReload=!1)}}else if(!(1>=d.length))j&&setTimeout(()=>{BookUtil.scrollClick(g,h)},BookUtil.isHashReload?15:75);else if(~i)BookUtil.referenceId?MiscUtil.scrollPageTop():BookUtil.scrollPageTop();else if(1===d.length&&BookUtil._lastClickedLink){const a=$(BookUtil._lastClickedLink),b=a.attr("href"),c=new RegExp(`^${UrlUtil.PG_ADVENTURE}#${BookUtil.curRender.curBookId},(\\d+)$`,"i").exec(b.trim());if(c){const a=+c[1],b=$(`#pagecontent tr.text td`).children(`.${Renderer.HEAD_NEG_1}`)[a];return void(b?b.scrollIntoView():setTimeout(()=>{throw new Error(`Failed to find header scroll target with index "${a}"`)}))}}(function(){if(BookUtil.referenceId){const b=BookUtil.curRender.controls;if(~i){const c=BookUtil.curRender.fromIndex.contents[i],d=c.headers.findIndex(a=>BookUtil.getHeaderText(a).toLowerCase()===BookUtil.curRender.lastRefHeader),e=0<i||~d&&0<d,f=i<a.length-1||~d&&d<c.headers.length-1;b.$btnsPrv.forEach(a=>a.toggle(!!e)),b.$btnsNxt.forEach(a=>a.toggle(!!f)),b.$divsPrv.forEach(a=>a.toggle(!e)),b.$divsNxt.forEach(a=>a.toggle(!f))}else b.$btnsPrv.forEach(a=>a.toggle(!1)),b.$btnsNxt.forEach(a=>a.toggle(!1)),b.$divsPrv.forEach(a=>a.toggle(!0)),b.$divsNxt.forEach(a=>a.toggle(!0))}})()},indexListToggle(a,b){a&&(a.stopPropagation(),a.preventDefault());const c=$(b),d=c.closest(`li`).find(`ul.bk-contents`);c.data("hidden")?(d.show(),c.data("hidden",!1),c.html(`[\u2013]`)):(d.hide(),c.data("hidden",!0),c.html(`[+]`))},initLinkGrabbers(){const a=$(`body`);a.on(`mousedown`,`.entry-title-inner`,function(a){a.preventDefault()}),a.on(`click`,`.entry-title-inner`,async function(a){const b=$(this),c=b.text().trim().replace(/\.$/,"");if(a.shiftKey)await MiscUtil.pCopyTextToClipboard(c),JqueryUtil.showCopiedEffect(b);else{const a=[BookUtil.curRender.chapter,c,b.parent().data("title-relative-index")].map(a=>UrlUtil.encodeForHash(a)),d=[`${window.location.href.split("#")[0]}#${BookUtil.curRender.curBookId}`,...a];await MiscUtil.pCopyTextToClipboard(d.join(HASH_PART_SEP)),JqueryUtil.showCopiedEffect(b,"Copied link!")}})},baseDataUrl:"",bookIndex:[],homebrewIndex:null,homebrewData:null,renderArea:null,referenceId:!1,isHashReload:!1,contentType:null,booksHashChange(){function a(a){return a.includes(Parser.SOURCE_JSON_TO_FULL[SRC_TYP])?a.replace(Parser.SOURCE_JSON_TO_FULL[SRC_TYP],Parser.sourceJsonToAbv(SRC_TYP)):a}async function b(b,c){document.title=`${b.name} - 5etools`,$(`.book-head-header`).html(a(b.name)),$(`.book-head-message`).html("Browse content. Press F to find, and G to go to page."),await BookUtil.pLoadBook(b,f,e,c),NavBar.highlightCurrentPage()}function c(){if(!window.location.hash)window.history.back();else throw $(`.initial-message`).text(`Loading failed\u2014could not find ${Parser.getArticle(BookUtil.contentType)} ${BookUtil.contentType} with ID "${f}." You may need to load it as homebrew.`),new Error(`No book with ID: ${f}`)}const[d,...e]=window.location.hash.slice(1).split(HASH_PART_SEP),f=decodeURIComponent(d);if(-1===BookUtil.curRender.chapter&&e.length&&"-1"!==e[0]&&UrlUtil.encodeForHash(BookUtil.curRender.curBookId)===UrlUtil.encodeForHash(f))return window.history.replaceState({},document.title,`${location.origin}${location.pathname}#${[d,-1,...e.slice(1)].join(HASH_PART_SEP)}`),BookUtil.booksHashChange();const g=BookUtil.bookIndex.find(a=>UrlUtil.encodeForHash(a.id)===UrlUtil.encodeForHash(f));g&&!g.uniqueId?b(g):g&&g.uniqueId?BrewUtil.pAddBrewData().then(a=>{a[BookUtil.homebrewData]||c();const d=(a[BookUtil.homebrewData]||[]).find(a=>UrlUtil.encodeForHash(a.id)===UrlUtil.encodeForHash(f));d||c(),b(g,d)}).catch(a=>{BrewUtil.pPurgeBrew(a)}):c()},_renderer:new Renderer().setEnumerateTitlesRel(!0),async pLoadBook(a,b,c,d){function e(d){const e=$(`.contents-item`);BookUtil.thisContents=e.filter(`[data-bookid="${UrlUtil.encodeForHash(b)}"]`),BookUtil.thisContents.show(),e.filter(`[data-bookid!="${UrlUtil.encodeForHash(b)}"]`).hide(),BookUtil.showBookContent(BookUtil.referenceId?d.data[BookUtil.referenceId]:d.data,a,b,c),BookUtil.addSearch(a,b)}if(d)e(d);else{const a=await DataUtil.loadJSON(`${BookUtil.baseDataUrl}${b.toLowerCase()}.json`);e(a)}},handleReNav(a){const b=window.location.hash.slice(1).toLowerCase(),c=$(a).attr("href").slice(1).toLowerCase();b===c&&(BookUtil.isHashReload=!0,BookUtil.booksHashChange())},_$body:null,_$findAll:null,_headerCounts:null,_lastHighlight:null,addSearch(a,b){function c(a){return`${UrlUtil.encodeForHash(b)}${HASH_PART_SEP}${~BookUtil.curRender.chapter?a.ch:-1}${a.header?`${HASH_PART_SEP}${UrlUtil.encodeForHash(a.header)}${HASH_PART_SEP}${a.headerIndex}`:""}`}function d(a){return a.name&&("entries"===a.type||"inset"===a.type||"section"===a.type)}function f(a,b,h,j,k,l){function m(a,b,c){var d=Math.min;let e=0,f=0,h="",k=b-1;for(;0<=k&&(h=a.charAt(k)+h," "===a.charAt(k)&&0===f&&e++,!(e>g));--k);h=h.trimStart();const l=0<k;e=0;let m="";const o=b===c?c+n.length:c;for(k=d(o,a.length);k<a.length&&(m+=a.charAt(k)," "===a.charAt(k)&&0===f&&e++,!(e>g));++k);m=m.trimEnd();const p=k<a.length,q=a.substr(b,j.length);return{preview:`${l?"...":""}${h}<span class="highlight">${q}</span>${m}${p?"...":""}`,match:`${h}${j}${m}`}}if(null==j)return;const n=l?+j.trim():j.toLowerCase().trim();if(!n)return;d(k)&&(BookUtil._headerCounts[k.name]===void 0?BookUtil._headerCounts[k.name]=0:BookUtil._headerCounts[k.name]++);let o;if(d(k)){o=Renderer.stripTags(k.name);const b=l?k.page===n:o.toLowerCase().includes(n);b&&h.push({ch:a,header:o,headerIndex:BookUtil._headerCounts[o],term:j.trim(),headerMatches:!0,page:k.page})}else o=b;if(k.entries)k.entries.forEach(b=>f(a,o,h,j,b,l));else if(k.items)k.items.forEach(b=>f(a,o,h,j,b,l));else if(k.rows)k.rows.forEach(b=>{const c=b.row?b.row:b;c.forEach(b=>f(a,o,h,j,b,l))});else if(k.tables)k.tables.forEach(b=>f(a,o,h,j,b,l));else if(k.entry)f(a,o,h,j,k.entry,l);else if("string"==typeof k||"number"==typeof k){if(l)return;const b=[];BookUtil._renderer.recursiveRender(k,b);const c=$(`<p>${b.join("")}</p>`).text(),d="number"==typeof k?c+"":c.toLowerCase();if(d.includes(n))if(!h.length||!(h[h.length-1].header===o&&h[h.length-1].headerIndex===BookUtil._headerCounts[o]&&h[h.length-1].previews)){const b=d.indexOf(n),e=d.lastIndexOf(n),f=[];b===e?f.push(m(c,b,b)):(f.push(m(c,b,b+n.length)),f.push(m(c,e,e+n.length))),h.push({ch:a,header:o,headerIndex:BookUtil._headerCounts[o],previews:f.map(a=>a.preview),term:j.trim(),matches:f.map(a=>a.match),headerMatches:o.toLowerCase().includes(n)})}else{const a=d.lastIndexOf(n),b=m(c,a,a+n.length),e=h[h.length-1];e.previews[1]=b.preview,e.matches[1]=b.match}}else if("image"!==k.type&&"gallery"!==k.type&&"link"!==k.type&&"abilityGeneric"!==k.type&&"cell"!==k.type)throw new Error("Unhandled entity type")}BookUtil._$body=BookUtil._$body||$(`body`),BookUtil._$body.on("click",()=>{BookUtil._$findAll&&BookUtil._$findAll.remove()}),BookUtil._$body.off("keypress"),BookUtil._$body.on("keypress",b=>{if(("f"===b.key||"g"===b.key)&&noModifierKeys(b)){if(MiscUtil.isInInput(b))return;b.preventDefault();const d="g"===b.key;$(`span.temp`).contents().unwrap(),BookUtil._lastHighlight=null,BookUtil._$findAll&&BookUtil._$findAll.remove(),BookUtil._$findAll=$(`<div class="f-all-wrapper"/>`).on("click",a=>{a.stopPropagation()});const e=$(`<div class="f-all-out">`),g=$(`<input class="form-control" placeholder="${d?"Go to page number...":"Find text..."}">`).on("keypress",b=>{if(b.stopPropagation(),"Enter"===b.key&&noModifierKeys(b)){const b=g.val();if(d&&!/^\d+$/.exec(b.trim()))return JqueryUtil.doToast({content:`Please enter a valid page number.`,type:"danger"});e.html("");const h=[],i=BookUtil.curRender.data;i.forEach((a,c)=>{BookUtil._headerCounts={},f(c,"",h,b,a,d)}),h.length?(e.show(),h.forEach(b=>{const f=$(`<p class="f-result"/>`),g=$(`<span/>`),h=b.headerMatches&&!b.page,i=$(`<a href="#${c(b)}">
									<i>${Parser.bookOrdinalToAbv(a.contents[b.ch].ordinal)} ${a.contents[b.ch].name}${b.header?` \u2013 ${h?`<span class="highlight">`:""}${b.header}${h?`</span>`:""}`:""}</i>
								</a>`);if(g.append(i),f.append(g),!d&&b.previews){const a=$(`<a href="#${c(b)}"/>`).click(function(){BookUtil.handleReNav(this)}),d=new RegExp(RegExp.escape(b.term),"gi");a.on("click",()=>{setTimeout(()=>{(null===BookUtil._lastHighlight||BookUtil._lastHighlight!==b.term.toLowerCase())&&(BookUtil._lastHighlight=b.term,$(`#pagecontent`).find(`p:containsInsensitive("${b.term}"), li:containsInsensitive("${b.term}"), td:containsInsensitive("${b.term}"), a:containsInsensitive("${b.term}")`).each((a,b)=>{$(b).html($(b).html().replace(d,"<span class='temp highlight'>$&</span>"))}))},15)}),a.append(`<span>${b.previews[0]}</span>`),b.previews[1]&&(a.append(" ... "),a.append(`<span>${b.previews[1]}</span>`)),f.append(a),i.on("click",()=>a.click())}else{if(b.page){const a=$(`<span>Page ${b.page}</span>`);f.append(a)}i.click(function(){BookUtil.handleReNav(this)})}e.append(f)})):e.hide()}});BookUtil._$findAll.append(g).append(e),BookUtil._$body.append(BookUtil._$findAll),g.focus()}});const g=2},getContentsItem(a,b,c){return`<li class="contents-item" data-bookid="${UrlUtil.encodeForHash(b.id)}" style="display: none;">
			<div class="bk__contents-header">
				<a id="${a}" href="#${UrlUtil.encodeForHash(b.id)}" class="bk__contents_header_link" title="${b.name}">
					<span class="name">${b.name}</span>
				</a>
				<a href="#${UrlUtil.encodeForHash(b.id)},-1" class="bk__contents_show_all" title="View Entire ${BookUtil.contentType.uppercaseFirst()} (Warning: Slow)">
					<span class="glyphicon glyphicon glyphicon-book" style="top: 0;"/>
				</a>
			</div>
			${BookUtil.makeContentsBlock(c)}
		</li>`}};"undefined"==typeof module?window.addEventListener("load",()=>$("body").on("click","a",a=>{let b=$(a.target);for(;b.length&&!b.is("a");)b=b.parent();BookUtil._lastClickedLink=b[0]})):module.exports.BookUtil=BookUtil;